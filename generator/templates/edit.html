{% extends 'base.html' %}

{% block content %}
<style>
    #editor {
        height: 80vh;
        resize: none;
        font-family: monospace;
    }
    #previewArea {
        height: 80vh;
        overflow-y: auto;
    }
</style>

<div class="container-fluid">
    <h3 class="mb-3">üõ†Ô∏è Edit & Preview README.md</h3>

    <div class="row gx-3">
        <!-- Editor -->
        <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Markdown Code</label>
            <textarea id="editor" class="form-control">{{ readme_content }}</textarea>
        </div>

        <!-- Preview -->
        <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Live Preview</label>
            <div id="previewArea" class="markdown-body border rounded p-3 bg-white shadow-sm">
                Live preview here...
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between mt-3">
        <a href="{% url 'home' %}" class="btn btn-secondary">‚Üê Back</a>

        <div>
            <a href="#" onclick="downloadReadme()" class="btn btn-outline-primary me-2">‚¨áÔ∏è Download</a>
            <button class="btn btn-success" onclick="saveChanges()">üíæ Save Changes</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const editor = document.getElementById('editor');
    const preview = document.getElementById('previewArea');

    function updatePreview() {
        preview.innerHTML = marked.parse(editor.value);
    }

    editor.addEventListener('input', updatePreview);
    document.addEventListener('DOMContentLoaded', updatePreview);

    function saveChanges() {
        fetch("{% url 'save_readme' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                'repo_url': '{{ repo_url }}',
                'readme_content': editor.value
            })
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('‚úÖ README.md saved!');
              } else {
                  alert('‚ùå Error: ' + data.error);
              }
          });
    }

    function downloadReadme() {
        const blob = new Blob([editor.value], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'README.md';
        a.click();
        URL.revokeObjectURL(url);
    }
</script>
{% endblock %}
